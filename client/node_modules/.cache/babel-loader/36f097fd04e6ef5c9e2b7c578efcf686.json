{"ast":null,"code":"import { BehaviorSubject } from 'rxjs';\nimport { authApiTokenUrl, authApiRefreshUrl, authApiRegisterUrl } from '../config/urlconfig';\nimport { apiUsername, apiPassword } from '../config/authcredentials';\nimport { handleResponse } from '../_helpers';\n\nvar jwt = require('jsonwebtoken');\n\nvar currentUserSubject = new BehaviorSubject(JSON.parse(localStorage.getItem('currentUser')));\nexport var authenticationService = {\n  login: login,\n  logout: logout,\n  register: register,\n  checkIfTokenExpired: checkIfTokenExpired,\n  refreshToken: refreshToken,\n  currentUser: currentUserSubject.asObservable(),\n\n  get currentUserValue() {\n    return currentUserSubject.value;\n  }\n\n};\n\nfunction login(username, password) {\n  var encodedAuth = new Buffer(\"\".concat(apiUsername, \":\").concat(apiPassword)).toString('base64');\n  var requestOptions = {\n    method: 'POST',\n    headers: {\n      'Authorization': \"Basic \".concat(encodedAuth)\n    }\n  };\n  return fetch(\"\".concat(authApiTokenUrl, \"&username=\").concat(username, \"&password=\").concat(password), requestOptions).then(handleResponse).then(function (user) {\n    // store user details and jwt token in local storage to keep user logged in between page refreshes\n    var authorities = jwt.decode(user.access_token, {\n      complete: true\n    }).payload.authorities;\n\n    if (authorities && typeof authorities !== 'undefined') {\n      var role = authorities[0];\n    } else {\n      var role = 'unauthenticated';\n    }\n\n    var currentUser = {\n      'username': username,\n      'tokendata': user,\n      'role': role\n    };\n    localStorage.setItem('currentUser', JSON.stringify(currentUser));\n    currentUserSubject.next(currentUser);\n    return user;\n  });\n}\n\n;\n\nfunction register(username, password) {\n  var requestOptions = {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json'\n    },\n    body: JSON.stringify({\n      'name': username,\n      'password': password\n    })\n  };\n  return fetch(authApiRegisterUrl, requestOptions).then(handleResponse).then(function (response) {\n    console.log(\"Registration for \".concat(username, \" resulted in: \").concat(response));\n    return response;\n  });\n}\n\nfunction checkIfTokenExpired(user) {\n  var token = user.tokendata;\n  var decodedToken = jwt.decode(token, {\n    complete: true\n  });\n  if (!decodedToken || decodedToken === 'undefined') return false;\n  var dateNow = new Date();\n  return decodedToken.exp < dateNow.getTime();\n}\n\n;\n\nfunction refreshToken() {\n  var encodedAuth = new Buffer(\"\".concat(apiUsername, \":\").concat(apiPassword)).toString('base64');\n  var requestOptions = {\n    method: 'POST',\n    headers: {\n      'Authorization': \"Basic \".concat(encodedAuth)\n    }\n  };\n  var refreshToken = localStorage.getItem('currentUser').tokendata.refresh_token;\n  fetch(\"\".concat(authApiRefreshUrl, \"&refresh_token=\").concat(refreshToken), requestOptions).then(handleResponse).then(function (user) {\n    var currentUser = localStorage.getItem('currentUser');\n    var updatedUser = {\n      'username': currentUser.userName,\n      'tokendata': user\n    };\n    localStorage.setItem('currentUser', JSON.stringify(updatedUser));\n    currentUserSubject.next(user);\n  });\n}\n\n;\n\nfunction logout() {\n  // remove user from local storage to log user out\n  localStorage.removeItem('currentUser');\n  currentUserSubject.next(null);\n}","map":{"version":3,"sources":["/Users/hajbo/BME/alkfelj/ALFHF2019-whyarewestillalive/client/src/_services/authentication.service.js"],"names":["BehaviorSubject","authApiTokenUrl","authApiRefreshUrl","authApiRegisterUrl","apiUsername","apiPassword","handleResponse","jwt","require","currentUserSubject","JSON","parse","localStorage","getItem","authenticationService","login","logout","register","checkIfTokenExpired","refreshToken","currentUser","asObservable","currentUserValue","value","username","password","encodedAuth","Buffer","toString","requestOptions","method","headers","fetch","then","user","authorities","decode","access_token","complete","payload","role","setItem","stringify","next","body","response","console","log","token","tokendata","decodedToken","dateNow","Date","exp","getTime","refresh_token","updatedUser","userName","removeItem"],"mappings":"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","sourcesContent":["import { BehaviorSubject } from 'rxjs';\n\nimport { authApiTokenUrl, authApiRefreshUrl, authApiRegisterUrl } from '../config/urlconfig';\nimport { apiUsername, apiPassword } from '../config/authcredentials';\nimport { handleResponse } from '../_helpers';\n\nvar jwt = require('jsonwebtoken');\nconst currentUserSubject = new BehaviorSubject(JSON.parse(localStorage.getItem('currentUser')));\n\nexport const authenticationService = {\n    login,\n    logout,\n    register,\n    checkIfTokenExpired,\n    refreshToken,\n    currentUser: currentUserSubject.asObservable(),\n    get currentUserValue() { return currentUserSubject.value }\n};\n\nfunction login(username, password) {\n    var encodedAuth = new Buffer(`${apiUsername}:${apiPassword}`).toString('base64');\n    const requestOptions = {\n        method: 'POST',\n        headers: {\n            'Authorization': `Basic ${encodedAuth}`\n        }\n    };\n\n    return fetch(`${authApiTokenUrl}&username=${username}&password=${password}`, requestOptions)\n        .then(handleResponse)\n        .then(user => {\n            // store user details and jwt token in local storage to keep user logged in between page refreshes\n            var authorities = jwt.decode(user.access_token, { complete: true }).payload.authorities;\n            if (authorities && typeof authorities !== 'undefined') {\n                var role = authorities[0];\n            } else {\n                var role = 'unauthenticated';\n            }\n\n            var currentUser = {\n                'username': username,\n                'tokendata': user,\n                'role': role\n            }\n            localStorage.setItem('currentUser', JSON.stringify(currentUser));\n            currentUserSubject.next(currentUser);\n\n            return user;\n        });\n};\n\nfunction register(username, password) {\n    const requestOptions = {\n        method: 'POST',\n        headers: {\n            'Content-Type': 'application/json'\n        },\n        body: JSON.stringify({\n            'name': username,\n            'password': password\n        })\n    };\n    return fetch(authApiRegisterUrl, requestOptions)\n        .then(handleResponse)\n        .then(response => {\n            console.log(`Registration for ${username} resulted in: ${response}`);\n            return response;\n        });\n}\n\nfunction checkIfTokenExpired(user) {\n    var token = user.tokendata;\n    var decodedToken = jwt.decode(token, { complete: true });\n    if (!decodedToken || decodedToken === 'undefined') return false;\n    var dateNow = new Date();\n    return (decodedToken.exp < dateNow.getTime());\n\n};\n\nfunction refreshToken() {\n    var encodedAuth = new Buffer(`${apiUsername}:${apiPassword}`).toString('base64');\n    const requestOptions = {\n        method: 'POST',\n        headers: {\n            'Authorization': `Basic ${encodedAuth}`\n        }\n    };\n    var refreshToken = localStorage.getItem('currentUser').tokendata.refresh_token;\n\n    fetch(`${authApiRefreshUrl}&refresh_token=${refreshToken}`, requestOptions)\n        .then(handleResponse)\n        .then(user => {\n            var currentUser = localStorage.getItem('currentUser');\n            var updatedUser = {\n                'username': currentUser.userName,\n                'tokendata': user\n            }\n            localStorage.setItem('currentUser', JSON.stringify(updatedUser));\n            currentUserSubject.next(user);\n        });\n};\n\nfunction logout() {\n    // remove user from local storage to log user out\n    localStorage.removeItem('currentUser');\n    currentUserSubject.next(null);\n}"]},"metadata":{},"sourceType":"module"}